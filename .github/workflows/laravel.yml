name: Deploy Laravel via FTP

on:
  push:
    branches: [ main ]

jobs:
  ftp-deploy:
    runs-on: ubuntu-latest
    name: FTP Deploy

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Limpeza m√°xima antes do deploy
        run: |
          echo "üßπ Limpando arquivos desnecess√°rios para o deploy..."
          rm -rf .git .github .gitignore
          rm -rf node_modules vendor tests
          rm -rf .vscode .idea
          rm -f .env .env.* composer.lock package-lock.json yarn.lock
          find . -name "*.log" -delete
          find . -name "*.sql" -delete
          find . -name "*.bak" -delete
          find . -name "*.tmp" -delete
          mkdir -p storage/framework/{cache,sessions,views}
          touch storage/framework/{cache,sessions,views}/.gitkeep

      - name: Listar arquivos locais antes do deploy
        run: |
          echo "üìÇ Estrutura local antes do deploy:"
          ls -la
          echo ""
          echo "üì¶ Tamanho do diret√≥rio:"
          du -sh .

      - name: Testar conex√£o FTP
        run: |
          echo "üîå Testando conex√£o com servidor FTP..."
          if ! curl -s --ftp-ssl -u "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" "ftp://${{ secrets.FTP_SERVER }}" ; then
            echo "::error::Erro na conex√£o FTP"
            exit 1
          fi
          echo "‚úÖ Conex√£o FTP OK!"

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          server-dir: /EmenegildoMarques/
          exclude: |
            **/node_modules/**
            **/vendor/**
            **/.git/**
            **/.github/**
            **/.idea/**
            **/.vscode/**
            **/storage/**
            .env
            .env.*
            *.log
            *.sql
            *.bak
            *.tmp
            composer.lock
            package-lock.json
            yarn.lock
            tests/**
          dry-run: false
          log-level: verbose

      - name: Verificar arquivos no servidor FTP
        continue-on-error: true
        run: |
          echo "üì° Verificando arquivos no servidor FTP..."
          curl -s --ftp-ssl -u "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" \
          "ftp://${{ secrets.FTP_SERVER }}/EmenegildoMarques/" || echo "‚ö†Ô∏è Falha ao listar diret√≥rio, mas continuando..."
